# 地中熱交換システム計算ツール - Claude開発ガイド

このドキュメントは、Claudeがこのプロジェクトを理解し、効果的に開発支援を行うためのガイドです。

## プロジェクト概要

地中熱交換システムの性能計算ツールで、Streamlitを使用したWebアプリケーションです。主に冷房運転時の排熱処理を想定し、地下水との熱交換による温度低下を計算します。U字管構造を前提とした配管セット単位での計算を行います。

## 主要な計算ロジック

### 1. 熱交換計算（NTU法）
```python
# 効率の計算
effectiveness = 1 - math.exp(-NTU)
# 最終温度
final_temp = initial_temp - effectiveness * (initial_temp - ground_temp)
```

### 2. 地下水温度上昇の考慮
- **デフォルト（循環なし）**：1回の通水時間を自動計算
  ```python
  transit_time = total_pipe_length / velocity
  ```
- **循環あり**：ユーザー指定の運転時間（1-60分）

### 3. 地下水体積の計算
```python
groundwater_volume = boring_volume - pipe_total_volume
# U字管なので配管体積は2倍（往路・復路）
pipe_total_volume = π × (outer_diameter/2)² × pipe_length × num_pipe_sets × 2
```

## コードの構成

### app.py（単一ファイル構成）
1. **ページ設定とタブ選択**（14-26行）
2. **計算ツールページ**
   - サイドバー入力（33-110行）：基本条件、配管条件、地下水温度設定
   - 単一配管計算タブ（115-460行）：詳細計算と結果表示
   - 複数配管比較タブ（462-750行）：管径別性能比較
3. **理論解説ページ**（750-850行）
4. **物性値データページ**（850-950行）

## 重要な設計判断

### 1. 配管仕様
- JIS G 3452規格に基づく正確な内径・外径データ
- U字管構造（往路・復路で1セット）
- 32A（内径33.5mm）が最適とされる理由：適切な流速と滞留時間のバランス
- 配管セット本数：1-5セットで設定可能

### 2. 物性値の扱い
- 平均温度（初期温度と地下水温度の平均）で物性値を決定
- 線形補間により中間温度の物性値を計算

### 3. 熱伝達係数
- 層流（Re < 2300）：Nu = 3.66
- 乱流（Re ≥ 2300）：Dittus-Boelter式（冷却時 n=0.3）
- 管外側：自然対流として300 W/m²·K

### 4. 制約条件
- 地下水温度上昇：最大5-20℃（ユーザー設定）
- 配管総面積：掘削径の80%以下（警告表示）
- 目標温度設定：冷房運転での目標出口温度（20-30℃）

## 開発時の注意点

### 1. Streamlitの特性
- ページ全体が再実行されるため、状態管理に注意
- `st.sidebar`での入力変更は即座に反映
- セクション間の視覚的区切りに`st.markdown("---")`を使用

### 2. 計算の流れ
1. 初期地下水温度で熱交換計算
2. 地下水温度上昇を計算（オプション）
3. 上昇後の温度で再計算
4. 目標温度との比較と最適化提案

### 3. エラー処理
- 地下水体積が負の場合の警告
- 温度上昇が上限を超えた場合の表示
- 目標温度を超過した場合の改善提案表示

### 4. UI設計の原則
- 配管セット本数の概念統一（往路・復路で1セット）
- セクション間の明確な区切り線
- 目標温度に基づく最適化提案

## よくある質問と回答

### Q: なぜ管長を2倍にしても温度降下が2倍にならないのか？
A: 熱交換効率は指数関数（ε = 1 - exp(-NTU)）で計算されるため、NTUが増加しても効率は飽和に向かいます。

### Q: 32Aが最適な理由は？
A: 流速と滞留時間のバランスが良く、NTUが適切な値（約0.327）になるためです。

### Q: 地下水温度上昇の計算根拠は？
A: ボーリング孔内の地下水のみを考慮した保守的な評価です。実際は地下水流動により熱が拡散されます。

### Q: 配管セット本数とは何か？
A: U字管構造において、往路と復路の2本の配管で1セットとする概念です。実際の施工では、1つのボーリング孔に往路・復路の配管を挿入します。

## 今後の拡張可能性

1. **地下水流動の考慮**
   - 透水係数に基づく流動計算
   - 熱拡散の時間依存評価

2. **暖房運転への対応**
   - 加熱時のNusselt数相関式（n=0.4）
   - 凍結防止の検討

3. **経済性評価**
   - 配管コストの考慮
   - 運転コストの試算

4. **データベース化**
   - 計算結果の保存
   - 過去の設計事例の参照

## デバッグのヒント

1. **温度が変わらない場合**
   - `operation_hours`の計算を確認
   - 地下水体積がゼロでないか確認
   - 目標温度設定が反映されているか確認

2. **エラーが出る場合**
   - `consider_circulation`の定義を確認
   - 配管外径データの存在を確認
   - 配管セット本数の設定値を確認

3. **結果が異常な場合**
   - 単位変換（mm→m、L/min→m³/s）を確認
   - 物性値の温度依存性を確認
   - 複数配管比較での初期値設定を確認

## コミット時の注意

- 日本語でのコミットメッセージ
- 機能追加・修正内容を明確に記載
- Claude署名の追加

## 最新の更新内容（v1.3.0）

### UI改善（2025-01-06）
- セクション間に視覚的区切り線を追加
- サイドバーに目標温度設定を追加（20-30℃）
- 「配管本数」を「配管セット本数」に統一
- U字管構造の説明をヘルプテキストに追加
- 複数配管比較での初期値を全て1セットに統一
- 最適化提案で目標温度を動的に参照