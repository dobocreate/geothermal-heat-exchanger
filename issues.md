# 地中熱交換簡易シミュレーター - 未解決課題

## 1. 地下水温度上昇の物理的制約の実装

### 現状の問題
- 「新しい水を連続供給」モードで、地下水温度が入口温度を超えて上昇する
- 例：入口30℃の水を60分流すと、地下水が35℃まで上昇し、出口温度が31.4℃になる
- これは熱力学的に不可能（30℃の水から熱を受け取って35℃になることはない）

### 原因
現在のコード（app.py 598行目付近）：
```python
# 温度上昇を制限
groundwater_temp_rise = min(groundwater_temp_rise, temp_rise_limit)
```
- `temp_rise_limit`（デフォルト5-20℃）で上昇幅のみを制限
- 地下水の絶対温度が入口温度を超えることを防いでいない

### 期待される動作
- 地下水温度は入口温度を超えてはいけない
- 「新しい水を連続供給」の場合、最終的に地下水温度と出口温度は入口温度（30℃）に収束すべき

### 修正案
以下のいずれかの方法で修正：

#### 案1：地下水温度の絶対値を制限
```python
# 地下水温度が入口温度を超えないように制限
effective_ground_temp = min(ground_temp + groundwater_temp_rise, initial_temp)
```

#### 案2：温度上昇幅を入口温度との差で制限
```python
# 最大上昇幅を計算
max_possible_rise = initial_temp - ground_temp  # 30 - 15 = 15℃
groundwater_temp_rise = min(groundwater_temp_rise, temp_rise_limit, max_possible_rise)
```

### 影響範囲
- 単一配管計算（556-604行目付近）
- 複数配管比較計算（974-1026行目付近）
- 両方に同じ修正を適用する必要がある

## 2. 「同じ水を循環」モードの収束挙動

### 現状
- 循環する水と地下水の温度が適切に収束しているか要検証
- 地下水温度の上昇制限が適切でない場合、非物理的な結果になる可能性

### 期待される動作
- 循環する水の温度と地下水温度は、熱平衡状態で同じ温度に収束
- その収束温度は、初期条件と熱容量比によって決まる

## 3. テストケースの追加

### 必要なテスト
1. 入口温度 = 地下水温度の場合（熱交換なし）
2. 長時間運転での収束確認
3. 極端な条件（非常に高い/低い温度差）での動作確認

## 4. ユーザーへの説明改善

### 現状の課題
- 地下水温度上昇の物理的意味が分かりにくい
- 「温度上昇上限値」の設定が何を制限しているか不明確

### 改善案
- helpテキストに物理的制約を明記
- 非現実的な結果が出た場合の警告表示
- 理論解説ページに収束挙動の説明を追加

## 実装優先度
1. **高**：地下水温度の物理的制約（熱力学第二法則違反の修正）
2. **中**：収束挙動の検証とテスト
3. **低**：UIの説明改善

## 次のステップ
1. 上記の修正案1または2を実装
2. 単体テストで収束挙動を確認
3. UIで非物理的な結果の警告を追加
4. ドキュメントの更新